name: Scrape and Update THE CITY Links

on:
  schedule:
    - cron: "0 11 * * *" # 7am NYC
    - cron: "0 17 * * *" # 1pm NYC
    - cron: "0 23 * * *" # 7pm NYC
  workflow_dispatch:

jobs:
  scrape-links:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch and write TheCity links to JSON
        run: |
          set -e

          THECITY_URL="https://www.thecity.nyc/category/campaign-2025/"
          OUTPUT_PATH="the-city-links.json"

          echo "üì° Fetching data from TheCity website..."

          # Fetch the raw HTML response
          RESPONSE=$(curl -s "$THECITY_URL")

          # Parse the response using Node.js (cheerio)
          LINKS=$(node -e "
          const cheerio = require('cheerio');
          const response = \`$RESPONSE\`;

          const $ = cheerio.load(response);
          const links = [];

          $('.entry-title a').each((index, element) => {
            if (index < 3) {
              const text = $(element).text().trim();
              const href = $(element).attr('href').trim();
              if (text.length >= 5 && href.length >= 5) {
                links.push({ text, href });
              }
            }
          });

          if (links.length !== 3) {
            console.log('‚ùå Expected exactly 3 links, but got', links.length);
            process.exit(1);
          }

          console.log(JSON.stringify(links, null, 4));
          ")

          # Check if links have been successfully parsed and validate
          if [ -z "$LINKS" ]; then
            echo "‚ùå Failed to parse any links"
            exit 1
          fi

          # Only write/commit if content changed
          if [ -f "$OUTPUT_PATH" ] && diff <(echo "$LINKS") "$OUTPUT_PATH" > /dev/null; then
            echo "‚úÖ No changes to write"
            exit 0
          fi

          echo "$LINKS" > "$OUTPUT_PATH"
          echo "‚úÖ Wrote new links to $OUTPUT_PATH"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add "$OUTPUT_PATH"
          git commit -m "Update TheCity links JSON [auto]" || echo "‚ö†Ô∏è Nothing to commit"
          git push

      - name: Done
        run: echo "üéâ The City links JSON updated successfully"
